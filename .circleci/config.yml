version: 2

jobs:
  build:
    docker:
      - image: circleci/golang
    environment:
      O: "ATNU"
      R: "soundscapes-of-text"
    steps:
      - checkout
      - run: echo ${CIRCLE_TOKEN}
      - run:
          name: Determine which directories have changed
          command: |
            git diff --no-commit-id --name-only -r `git log -n 2 --oneline --pretty=format:"%h" | tail -n1` | cut -d/ -f1 | sort -u >  projects
            printf "Modified directories:\n"
            cat projects
            while read project; do
              if grep -Fxq $project projects.txt; then
                printf "\nTriggerring build for dir: "$dir
                curl -s -d build_parameters[CIRCLE_JOB]=${project} https://circleci.com/api/v1.1/project/github/$O/$R/tree/$CIRCLE_BRANCH?circle-token=67652ac1a6d9c0d844f36f98de608c4628dfcb28
              fi
            done <projects

  server:
    docker:
      - image: circleci/golang:1.12
    working_directory: /go/src/github.com/ATNU/soundscapes-of-text/server

    steps:
      - checkout:
          path: /go/src/github.com/ATNU/soundscapes-of-text

      - restore_cache:
          keys:
            - v1-pkg-cache

      - run: go get github.com/spf13/viper
      - run: go get github.com/gorilla/mux
      - run: go get github.com/fsnotify/fsnotify
      - run: go get github.com/aws/aws-sdk-go/aws/session
      - run: go get github.com/aws/aws-sdk-go/service/polly
      - run: go get github.com/aws/aws-sdk-go/aws
      - run: go get github.com/aws/aws-sdk-go/service/polly/pollyiface

      - run: CGO_ENABLED=0 GOOS=linux go build -a -installsuffix nocgo -o app .

      - save_cache:
          key: v1-pkg-cache
          paths:
            - "/go/pkg"